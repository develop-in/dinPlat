<?xml version="1.0" encoding= "UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<mapper namespace="collect">

	<!-- Collect List Select 문 -->
	    <sql id="collectListSQL">
		select concat(@rownum := @rownum + 1) as no,
			   newsno,
		       case effectrange
					when '1' then '사회전반'
					when '2' then '특정산업군'
					when '3' then '특정테마'
					when '4' then '특정종목'
					else '기타'
					end as effectrange,
			   case newstype
			   		when '1' then '정부정책'
			   		when '2' then 'Global뉴스'
			   		when '3' then '국내뉴스'
			   		when '4' then '단순전망'
			   		when '5' then '공시'
			   		else '기타' 
			   		end as newstype,
			   title,
			   newstime,
			   case trackingtype
			   		when '1' then 'Open'
			   		when '2' then 'Close'
			   		else 'None'
			   		end as trackingtype,
			   case signaltype
			   		when '1' then '관망'
			   		when '2' then '매수'
			   		when '3' then '호재종목매수'
			   		when '4' then '매도'
			   		when '5' then '악재종목매도'
			   		end as signaltype
		from   sg_news a,
		       (select @rownum := #{start}) b
	</sql>
	
	
	<!-- Collect List -->
    <select id="collectList" parameterType="java.util.HashMap" resultType="java.util.HashMap">
		<include refid="collectListSQL"/>
		<if test="trackingType != null and trackingType != '' and trackingType != 0">
		where  trackingtype = #{trackingType}
		</if>
		order by newstime desc
		LIMIT #{start}, #{end}
	</select>
	
	
	<!-- Collect List Count -->
    <select id="collectListCount" parameterType="java.util.HashMap" resultType="java.lang.Integer">
		select count(*)
		from   sg_news
		<if test="trackingType != null and trackingType != '' and trackingType != 0">
		where  trackingtype = #{trackingType}
		</if>
	</select>
	
	
	<!-- detail info -->
	<select id="detailInfo" parameterType="java.lang.String" resultType="java.util.HashMap">
		select substr(newstime,1,4) as newsYear,
		       substr(newstime,5,2) as newsMonth,
		       substr(newstime,7,2) as newsDay,
		       effectrange as effectrangevalue,
			   case effectrange
					when '1' then '사회전반'
					when '2' then '특정산업군'
					when '3' then '특정테마'
					when '4' then '특정종목'
					else '기타'
					end as effectrange,
			   newstype as newstypevalue,
			   case newstype
			   		when '1' then '정부정책'
			   		when '2' then 'Global뉴스'
			   		when '3' then '국내뉴스'
			   		when '4' then '단순전망'
			   		when '5' then '공시'
			   		else '기타' 
			   		end as newstype,
			   title,
			   newstime,
			   contents,
			   comment,
			   trackingtype as trackingtypevalue,
			   case trackingtype
			   		when '1' then 'Open'
			   		when '2' then 'Close'
			   		else 'None'
			   		end as trackingtype,
			   signaltype as signaltypevalue,
			   case signaltype
			   		when '1' then '관망'
			   		when '2' then '매수'
			   		when '3' then '호재종목매수'
			   		when '4' then '매도'
			   		when '5' then '악재종목매도'
			   		end as signaltype,
			   signalmessage
		from   sg_news
		where  newsno = #{newsNo}
	</select>
	
	<!-- News Category -->
	<select id="newsCategory" parameterType="java.lang.String" resultType="java.util.HashMap">
		select a.gbtype as gbtype, 
			   a.category as category, 
			   a.categoryid as categoryid,
			   b.industryname as categoryname
		from   sg_news_category a, sg_industry_code b
		where  a.newsno = #{newsNo}
		and    a.category = '1'
		and    a.categoryid = b.industryid
		union
		select a.gbtype as gbtype, 
			   a.category as category, 
			   a.categoryid as categoryid,
			   b.ksename as categoryname
		from   sg_news_category a, sg_kse_code b
		where  a.newsno = #{newsNo}
		and    a.category = '2'
		and    a.categoryid = b.kseid
		union
		select a.gbtype as gbtype, 
			   a.category as category, 
			   a.categoryid as categoryid,
			   b.ficsname as categoryname
		from   sg_news_category a, sg_fics_code b
		where  a.newsno = #{newsNo}
		and    a.category = '3'
		and    a.categoryid = b.ficsid
		union
				select a.gbtype as gbtype, 
			   a.category as category, 
			   a.categoryid as categoryid,
			   b.themename as categoryname
		from   sg_news_category a, sg_theme_code b
		where  a.newsno = #{newsNo}
		and    a.category = '4'
		and    a.categoryid = b.themeid
		order by gbtype,category,categoryid
	</select>
	
	
	<!-- Tracking 리스트 -->
	<select id="trackingList" parameterType="java.lang.String" resultType="java.util.HashMap">
		select trackingno,
			   substr(trackingtime,1,4) as trackingYear,
		       substr(trackingtime,5,2) as trackingMonth,
		       substr(trackingtime,7,2) as trackingDay,
		       title,
		       contents,
		       comment
		from   sg_news_tracking
		where  newsno = #{newsNo}
		order by trackingno desc;
	</select>
	
	
	<!-- 뉴스등록 -->
	<insert id="insert_sg_news" parameterType="java.util.HashMap">
		insert into sg_news (effectrange, newstype, title, newstime, contents, comment, trackingtype, signaltype, signalmessage, regdate)
		values(#{effectRange}, #{newsType}, #{title}, concat(#{newsYear},#{newsMonth},#{newsDay}), #{contents}, #{comment}, 
		       #{trackingType}, #{signalType}, #{signalMessage}, date_format(NOW(), '%Y%m%d'))
		<selectKey resultType="Integer"	keyProperty="newsNo" order="AFTER">
            select last_insert_id()
        </selectKey>
	</insert>
	
	<!-- 뉴스수정 -->
	<update id="update_sg_news" parameterType="java.util.HashMap">
		update sg_news set effectrange = #{effectRange},
						   newstype = #{newsType},
						   title = #{title},
						   newstime = concat(#{newsYear},#{newsMonth},#{newsDay}),
						   contents = #{contents},
						   comment = #{comment},
						   trackingType = #{trackingType},
						   signaltype = #{signalType},
						   signalmessage = #{signalMessage},
						   moddate = date_format(NOW(), '%Y%m%d')
		where newsno = #{newsNo}
	</update>
	
	<!-- 뉴스카테고리 삭제 -->
	<delete id="delete_sg_news_category" parameterType="java.lang.Integer">
		delete from sg_news_category 
		where  newsno = #{newsNo}
	</delete>
	
	<!-- 뉴스카테고리 등록 -->
	<insert id="insert_sg_news_category" parameterType="java.util.HashMap">
		insert into sg_news_category(newsno, gbtype, category, categoryid)
		values
		<foreach collection="category" item="item" separator=",">
		(#{item.newsNo}, #{item.gbType}, #{item.category}, #{item.categoryId})
		</foreach>
	</insert>
	
	<!-- Tracking 등록 -->
	<insert id="insert_sg_news_tracking" parameterType="java.util.HashMap">
		insert into sg_news_tracking(newsno, trackingno, trackingtime, title, contents, comment, regdate) 
		value (#{newsNo}, #{trackingNo}, concat(#{trackingYear},#{trackingMonth},#{trackingDay}), #{trackingTitle}, #{trackingContents}, #{trackingComment}, date_format(NOW(), '%Y%m%d%H%i%s'))
	</insert>
	
	<!-- Tracking 삭제 -->
	<delete id="delete_sg_news_tracking" parameterType="java.util.HashMap">
		delete from sg_news_tracking
		where  newsno = #{newsNo}
		and    trackingno = #{trackingNo}
	</delete>
	
	<!-- Tracking 수정 -->
	<update id="update_sg_news_tracking" parameterType="java.util.HashMap">
		update sg_news_tracking set trackingtime = concat(#{trackingYear},#{trackingMonth},#{trackingDay}),
									title = #{trackingTitle},
									contents = #{trackingContents},
									comment = #{trackingComment}
		where newsno = #{newsNo}
		and   trackingno = #{trackingNo}
	</update>
</mapper>
